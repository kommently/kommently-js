name: Release

on:
  push:
    tags:
      - "*"

permissions:
  contents: write
  id-token: write

jobs:
  prepare:
    if: github.event.repository.fork == false
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.resolve.outputs.tag }}
      publish_package: ${{ steps.resolve.outputs.publish_package }}
      package_dir: ${{ steps.resolve.outputs.package_dir }}
      package_name: ${{ steps.resolve.outputs.package_name }}
      package_version: ${{ steps.resolve.outputs.package_version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve tag target
        id: resolve
        env:
          TAG: ${{ github.ref_name }}
        shell: bash
        run: |
          set -euo pipefail

          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

          if [[ "${TAG}" =~ ^@[^/]+/[^@]+@[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?$ ]]; then
            PACKAGE_NAME="${TAG%@*}"
            PACKAGE_VERSION="${TAG##*@}"

            MATCHED_DIR="$(node -e "const fs=require('fs');const path=require('path');const root=path.resolve('packages');for (const d of fs.readdirSync(root)){const p=path.join(root,d,'package.json');if(!fs.existsSync(p)) continue;const pkg=JSON.parse(fs.readFileSync(p,'utf8'));if(pkg.name===process.argv[1]){process.stdout.write(path.join('packages',d));process.exit(0);}}process.exit(1);" "${PACKAGE_NAME}")"

            ACTUAL_VERSION="$(node -e "const fs=require('fs');const pkg=JSON.parse(fs.readFileSync(process.argv[1],'utf8'));process.stdout.write(String(pkg.version||''));" "${MATCHED_DIR}/package.json")"

            if [[ "${ACTUAL_VERSION}" != "${PACKAGE_VERSION}" ]]; then
              echo "::error::Tag version ${PACKAGE_VERSION} does not match ${PACKAGE_NAME} package.json version ${ACTUAL_VERSION}."
              exit 1
            fi

            echo "publish_package=true" >> "$GITHUB_OUTPUT"
            echo "package_dir=${MATCHED_DIR}" >> "$GITHUB_OUTPUT"
            echo "package_name=${PACKAGE_NAME}" >> "$GITHUB_OUTPUT"
            echo "package_version=${PACKAGE_VERSION}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "publish_package=false" >> "$GITHUB_OUTPUT"
          echo "package_dir=" >> "$GITHUB_OUTPUT"
          echo "package_name=" >> "$GITHUB_OUTPUT"
          echo "package_version=" >> "$GITHUB_OUTPUT"

  publish-package:
    needs: prepare
    if: needs.prepare.outputs.publish_package == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org

      - name: Upgrade npm CLI for trusted publishing
        run: npm i -g npm@latest

      - name: Publish package to npm (OIDC)
        env:
          PACKAGE_DIR: ${{ needs.prepare.outputs.package_dir }}
        shell: bash
        run: |
          set -euo pipefail
          npm --version
          cd "${PACKAGE_DIR}"
          npm publish --access public --provenance

  create-release:
    needs: [prepare, publish-package]
    if: always() && needs.prepare.result == 'success' && (needs.publish-package.result == 'success' || needs.publish-package.result == 'skipped')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.prepare.outputs.tag }}
          PACKAGE_NAME: ${{ needs.prepare.outputs.package_name }}
          PACKAGE_VERSION: ${{ needs.prepare.outputs.package_version }}
        shell: bash
        run: |
          set -euo pipefail

          if [[ -n "${PACKAGE_NAME}" && -n "${PACKAGE_VERSION}" ]]; then
            TITLE="${PACKAGE_NAME} v${PACKAGE_VERSION}"
          else
            TITLE="${TAG}"
          fi

          gh release create "${TAG}" \
            --target "${GITHUB_SHA}" \
            --title "${TITLE}" \
            --generate-notes
