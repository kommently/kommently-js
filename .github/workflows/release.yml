name: Release

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Release target"
        required: true
        type: choice
        options:
          - react
          - monorepo
      version:
        description: "Version (without v), e.g. 1.0.2"
        required: true
        type: string

permissions:
  contents: write
  id-token: write

jobs:
  release:
    if: github.event.repository.fork == false
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate inputs and resolve release metadata
        id: meta
        env:
          TARGET: ${{ inputs.target }}
          VERSION: ${{ inputs.version }}
        shell: bash
        run: |
          set -euo pipefail

          if [[ ! "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?$ ]]; then
            echo "::error::Version must be semver like 1.0.2 or 1.0.2-beta.1"
            exit 1
          fi

          if [[ "${TARGET}" == "react" ]]; then
            PACKAGE_DIR="packages/react"
            PACKAGE_NAME="@kommently/react"
            PACKAGE_VERSION="$(node -e "const fs=require('fs');const pkg=JSON.parse(fs.readFileSync('packages/react/package.json','utf8'));process.stdout.write(String(pkg.version||''));")"

            if [[ "${PACKAGE_VERSION}" != "${VERSION}" ]]; then
              echo "::error::packages/react/package.json version is ${PACKAGE_VERSION}, expected ${VERSION}."
              exit 1
            fi

            TAG="${PACKAGE_NAME}@${VERSION}"
            TITLE="${PACKAGE_NAME} v${VERSION}"
            SHOULD_PUBLISH="true"
          else
            TAG="v${VERSION}"
            TITLE="kommently-js v${VERSION}"
            PACKAGE_DIR=""
            PACKAGE_NAME=""
            SHOULD_PUBLISH="false"
          fi

          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            echo "::error::Tag ${TAG} already exists."
            exit 1
          fi

          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "title=${TITLE}" >> "$GITHUB_OUTPUT"
          echo "package_dir=${PACKAGE_DIR}" >> "$GITHUB_OUTPUT"
          echo "package_name=${PACKAGE_NAME}" >> "$GITHUB_OUTPUT"
          echo "should_publish=${SHOULD_PUBLISH}" >> "$GITHUB_OUTPUT"

      - name: Setup Node.js
        if: steps.meta.outputs.should_publish == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Upgrade npm CLI for trusted publishing
        if: steps.meta.outputs.should_publish == 'true'
        run: npm i -g npm@latest

      - name: Ensure tokenless npm auth for OIDC
        if: steps.meta.outputs.should_publish == 'true'
        shell: bash
        run: |
          set -euo pipefail
          rm -f ~/.npmrc .npmrc

      - name: Publish package to npm (OIDC)
        if: steps.meta.outputs.should_publish == 'true'
        env:
          PACKAGE_DIR: ${{ steps.meta.outputs.package_dir }}
        shell: bash
        run: |
          set -euo pipefail
          npm --version
          cd "${PACKAGE_DIR}"
          npm publish --registry https://registry.npmjs.org --access public --provenance

      - name: Create and push git tag
        env:
          TAG: ${{ steps.meta.outputs.tag }}
        shell: bash
        run: |
          set -euo pipefail
          git tag "${TAG}" "${GITHUB_SHA}"
          git push origin "${TAG}"

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.meta.outputs.tag }}
          TITLE: ${{ steps.meta.outputs.title }}
        shell: bash
        run: |
          set -euo pipefail
          gh release create "${TAG}" \
            --target "${GITHUB_SHA}" \
            --title "${TITLE}" \
            --generate-notes
